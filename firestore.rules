rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    function isHost(gameId) {
      return isSignedIn() && get(/databases/$(database)/documents/games/$(gameId)).data.hostUserId == request.auth.uid;
    }

    // Admin registry
    match /admins/{uid} {
      allow read: if isSignedIn();
      // Only existing admins can manage admins.
      // Bootstrap: create the first admin document manually in Firebase Console.
      allow create, update, delete: if isAdmin();
    }

    // Games (metadata)
    match /games/{gameId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.hostUserId == request.auth.uid;

      // Only host or admin can update game metadata/scores/settings.
      allow update, delete: if isHost(gameId) || isAdmin();

      // Square claims live in a subcollection.
      match /squares/{cellKey} {
        allow read: if isSignedIn();

        function isValidClaim(claim) {
          return claim.name is string && claim.claimedAt is int;
        }

        // Anyone signed in can claim an unclaimed square for themselves.
        allow create: if isSignedIn()
          && request.resource.data.claims is map
          && request.resource.data.claims.keys().size() == 1
          && request.resource.data.claims.keys().hasAny([request.auth.uid])
          && isValidClaim(request.resource.data.claims[request.auth.uid]);

        // Users can add ONLY themselves as an additional claimant (max 3 total).
        // Host/admin can modify or remove claims for moderation.
        allow update: if isHost(gameId) || isAdmin() || (
          isSignedIn()
          && resource.data.claims is map
          && request.resource.data.claims is map
          && request.resource.data.claims.keys().size() <= 3
          && request.resource.data.claims.keys().hasAll(resource.data.claims.keys())
          && request.resource.data.claims.keys().hasAny([request.auth.uid])
          && request.resource.data.claims.diff(resource.data.claims).removedKeys().size() == 0
          && request.resource.data.claims.diff(resource.data.claims).changedKeys().size() == 0
          && (
            request.resource.data.claims.diff(resource.data.claims).addedKeys().size() == 0
            || (
              request.resource.data.claims.diff(resource.data.claims).addedKeys().size() == 1
              && request.resource.data.claims.diff(resource.data.claims).addedKeys().hasAny([request.auth.uid])
            )
          )
          && isValidClaim(request.resource.data.claims[request.auth.uid])
        );

        allow delete: if isHost(gameId) || isAdmin();
      }
    }
  }
}